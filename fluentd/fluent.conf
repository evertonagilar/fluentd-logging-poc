<source>
  @type forward
  port 24224
  bind 0.0.0.0
  <parse>
    @type json
  </parse>
</source>

### docker.logify ###

<filter docker.logify>
  @type parser
  key_name log
  reserve_data false
  <parse>
    @type json
  </parse>
</filter>

<filter docker.logify>
  @type record_transformer
  enable_ruby true
  remove_keys emailAddress
  <record>
    hostname "#{Socket.gethostname}"
    timestamp ${Time.at(record["timestamp"]).strftime("%Y-%m-%dT%H:%M:%S.%L%z")}
    is_successful ${record["status"] == 200 ? "true" : "false"}
    ip ${record["ip"]&.gsub(/(\d+\.\d+\.\d+\.\d+)/, 'REDACTED')}
  </record>
</filter>

<match docker.logify>
  @type stdout
  <format>
  @type json
  </format>
</match>


### docker.sie ###

<filter docker.sie>
  @type parser
  key_name log
  reserve_data false
  <parse>
    @type json
  </parse>
</filter>

<filter docker.sie>
  @type record_transformer
  enable_ruby true
  remove_keys LoggerName
  <record>
    hostname "#{Socket.gethostname}"
    #timestamp ${Time.at(record["timestamp"]).strftime("%Y-%m-%dT%H:%M:%S.%L%z")}
    is_successful ${record["LogMessage"].downcase.include?("error") ? false : true}
    is_db_error ${record["LogMessage"].downcase.include?("ERRORCODE=") ? true : false}
    is_conn_error ${record["LogMessage"].downcase.include?("ERRORCODE=-4499") ? true : false}
    #ip ${record["ip"]&.gsub(/(\d+\.\d+\.\d+\.\d+)/, 'REDACTED')}
  </record>
</filter>

# <match docker.sie>
#   @type stdout
#   <format>
#   @type json
#   </format>
# </match>

<match docker.sie>
  @type logtail
  @id output_logify_logtail
  source_token ${ENV['TOKEN_DOCKER_SIE']}
  flush_interval 2 # in seconds
</match>


##########################################3

# <match docker.logify.**>
#   @type logtail
#   @id output_logify_logtail
#   source_token ${ENV['TOKEN_DOCKER_LOGIFY']}
#   flush_interval 2 # in seconds
# </match>


# <match docker.nginx.**>
#   @type logtail
#   @id output_nginx_logtail
#   source_token ${ENV['TOKEN_DOCKER_NGINX']}
#   flush_interval 2 # in seconds
# </match>

# <label @FLUENT_LOG>
# <match fluent.*>
#   @type logtail
#   @id output_fluent_logtail
#   source_token ${ENV['TOKEN_FLUENT_LOG']}
#   flush_interval 2 # in seconds
# </match>
# </label>



# <match docker.nginx>
#   @type stdout
#   <format>
#   @type json
#   </format>
# </match>

